{% extends 'inventory/base.html' %}
{% block title %}
    List of components
{% endblock %}
{% load static %}
{% block content %}
    {% if component_list %}



        <section class="py-4">

            <div style="overflow-x: scroll;" class="container">
                <h3 class="fw-bolder text-center">List of components</h3>
                <br/>
                <div id="search" class="container mt-3 mb-3">
                    <input id="search_here" class="form-control" placeholder="type here to search"/>
                    <div id="search-box" class="mt-3">
                        {% for item in component_list %}
                            <b>{{ item }}</b><br>
                        {% endfor %}
                    </div>
                </div>

                <div class="card rounded-0 shadow">
                    <div class="card-body">
                        <div class="container-fluid">
                            <table class="table table-bordered table-striped" id="category-tbl">
                                <colcategory>
                                    <col width="5%"/>
                                    <col width="7%"/>
                                    <col width="20%"/>
                                    <col width="20%"/>
                                    <col width="20%"/>
                                    <col width="20%"/>
                                    <col width="20%"/>
                                    <col width="5%"/>
                                </colcategory>
                                <thead>
                                <tr>
                                    <th>ID</th>
                                    <th>Name</th>
                                    <th>SKU | MPN | UPC</th>
                                    <th>Description</th>
                                    <th>Measurement Unit</th>
                                    <th>Storage Bins</th>
                                    <th>Barcode</th>

                                    <th>Qty</th>
                                </tr>
                                </thead>
                                <tbody id="databody">
                                {% for component in component_list %}
                                    <tr>
                                        <td style=" vertical-align: middle;" class="text-center">{{ component.pk }}</td>

                                        <td style=" vertical-align: middle;">
                                            <a href="{{ component.get_absolute_url }}">{{ component.name|capfirst }}</a>
                                        </td>

                                        <td style=" vertical-align: middle; ">{{ component.sku }} | {{ component.mpn }}
                                            | {{ component.upc }}</td>
                                        <td style=" vertical-align: middle;">
                                            <p style="font-size:15px; line-height: 1.5;">{{ component.description }}</p>
                                        </td>

                                        <td style=" vertical-align: middle; text-transform: capitalize; ">
                                            <a href="{{ component.measurement_unit.get_absolute_url }}">{{ component.measurement_unit.unit_name }}</a>
                                        </td>

                                        <td style="vertical-align: middle;  padding-left: 20px;text-transform: capitalize; ">
                                            {% for bin in component.storage_bin.all %}
                                                <li>
                                                    <a href="{{ bin.get_absolute_url }}">{{ bin.name }}</a>
                                                </li>
                                            {% endfor %}
                                        </td>

                                        <td style=" vertical-align: middle; ">
                                            <img src="{{ component.barcode.url }} " style=" height: auto; width: 30%;"/>

                                            <br/>
                                            {{ component.barcode }}
                                        </td>
                                        <td style=" vertical-align: middle; ">{{ component.qty }}</td>
                                    </tr>
                                {% endfor %}
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </section>
    {% else %}
        <p>There are no components in the database.</p>
    {% endif %}

    {% block scripts %}
        <script>
            const databody = document.getElementById('databody')

            // console.log(data)
            function init() {
                $.ajax({
                    url: '{{ REST_URL }}rest/components/?search=',
                    dataType: 'JSON',
                    success: function (data) {
                        console.log(data)
                        //  for (var i = 0; i < data.length; i++) {
                        //   var row =
                        //       $('<tr> .. ..........</tr>');
                        //    $("#table").append(row);
                        //  }
                    }
                });
            }

            function search(search) {
                console.log("search!!:" +search)
                $.ajax({

                    url: '{{ REST_URL }}rest/components/?search=' + search,
                    dataType: 'JSON',
                    success: function (data) {
                        console.log(data)
                        databody.innerHTML = '';
                        for (let item of data) {
                            let row = document.createElement('tr');

                            let td1 = document.createElement('td');
                            td1.style.verticalAlign = 'middle';
                            td1.textContent = item["url"].toString().split("/components/")[1];
                            row.appendChild(td1);

                            let td2 = document.createElement('td');
                            td2.style.verticalAlign = 'middle';
                            let a2 = document.createElement('a');
                            a2.href = item["url"];
                            a2.textContent = item["name"].charAt(0).toUpperCase() + item["name"].slice(1);
                            td2.appendChild(a2);
                            row.appendChild(td2);



                            let td3 = document.createElement('td');
                            td3.style.verticalAlign = 'middle';
                            td3.textContent = `${item["sku"]} | ${item["mpn"]} | ${item["upc"]}`;
                            row.appendChild(td3);


                            let td4 = document.createElement('td');
                            td4.style.verticalAlign = 'middle';
                            let p4 = document.createElement('p');
                            p4.style.fontSize = '15px';
                            p4.style.lineHeight = '1.5';
                            p4.textContent = item["description"];
                            td4.appendChild(p4);
                            row.appendChild(td4);

                            let td5 = document.createElement('td');
                            td5.style.verticalAlign = 'middle';
                            let a5 = document.createElement('a');
                            a5.href = item["measurement_unit"]["url"].toString().replaceAll("/rest", "");
                            a5.textContent = item["measurement_unit"]["unit_name"].charAt(0).toUpperCase() + item["measurement_unit"]["unit_name"].slice(1);
                            td5.appendChild(a5);
                            row.appendChild(td5);


                            let td6 = document.createElement('td');
                            td6.style.verticalAlign = 'middle';
                            td6.style.paddingLeft = '20px';
                            td6.style.textTransform = 'capitalize';
                            let ul6 = document.createElement('div');
                            for (let bin of item["storage_bin"]) {
                                let li = document.createElement('li');
                                let a6 = document.createElement('a');
                                a6.href = bin["url"];
                                a6.textContent = bin["name"];
                                li.appendChild(a6);
                                ul6.appendChild(li);
                            }
                            td6.appendChild(ul6);
                            row.appendChild(td6);

                            let td7 = document.createElement('td');
                            td7.style.verticalAlign = 'middle';
                            let img = document.createElement('img');
                            img.src = item["barcode"];
                            img.style.height = 'auto';
                            img.style.width = '30%';
                            let br = document.createElement('br');
                            let barcodeText = document.createElement('span');
                            barcodeText.textContent = item["barcode"];
                            td7.appendChild(img);
                            td7.appendChild(br);
                            td7.appendChild(barcodeText);
                            row.appendChild(td7);


                            let td8 = document.createElement('td');
                            td8.style.verticalAlign = 'middle';
                            td8.textContent = item["qty"];
                            row.appendChild(td8);


                            databody.appendChild(row);



                        }

                    }
                });
            }

            $(document).ready(init)
            const data = '{{qs_json}}'

            const rdata = JSON.parse(data.replace(/&quot;/g, '"'))

            const input = document.getElementById('search_here')
            const box = document.getElementById('search-box')

            let filteredArr = []

            input.addEventListener('keyup', (e) => {
                box.innerHTML = ""
                search(e.target.value)

                //  filteredArr = rdata.filter(info => info['name'].includes(e.target.value))
                /*
                if (filteredArr.length > 0) {
                     filteredArr.map(item => {
                         box.innerHTML += `<b>${item['name']}</b><br>`
                     })

                 } else {
                     box.innerHTML = "<b>No Results Found</b>"
                 }

                 */
            })

        </script>
    {% endblock %}
{% endblock %}
